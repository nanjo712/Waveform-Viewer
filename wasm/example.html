<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VCD Waveform Parser - WASM Demo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1e1e2e;
      color: #cdd6f4;
      padding: 24px;
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 { color: #89b4fa; margin-bottom: 8px; }
    h2 { color: #a6adc8; font-size: 14px; font-weight: normal; margin-bottom: 24px; }
    h3 { color: #89b4fa; margin: 16px 0 8px; font-size: 16px; }

    .card {
      background: #313244;
      border: 1px solid #45475a;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .card label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #bac2de;
    }
    input[type="file"] {
      background: #45475a;
      border: 1px solid #585b70;
      border-radius: 4px;
      color: #cdd6f4;
      padding: 8px 12px;
      cursor: pointer;
      width: 100%;
    }
    input[type="number"], input[type="text"] {
      background: #45475a;
      border: 1px solid #585b70;
      border-radius: 4px;
      color: #cdd6f4;
      padding: 8px 12px;
      width: 120px;
      font-family: monospace;
    }
    button {
      background: #89b4fa;
      color: #1e1e2e;
      border: none;
      border-radius: 4px;
      padding: 8px 20px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    button:hover { background: #74c7ec; }
    button:disabled { background: #585b70; color: #a6adc8; cursor: not-allowed; }

    #status {
      padding: 10px 14px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-family: monospace;
      font-size: 13px;
    }
    #status.loading { background: #313244; color: #f9e2af; }
    #status.ready   { background: #1e3a2e; color: #a6e3a1; }
    #status.error   { background: #3e1e1e; color: #f38ba8; }

    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
    }
    .meta-item {
      background: #45475a;
      padding: 8px 12px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 13px;
    }
    .meta-item .label { color: #a6adc8; font-size: 11px; }
    .meta-item .value { color: #cdd6f4; }

    .signal-list {
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
    }
    .signal-item {
      padding: 4px 8px;
      border-bottom: 1px solid #45475a;
      display: flex;
      justify-content: space-between;
    }
    .signal-item:hover { background: #45475a; }
    .signal-path { color: #89b4fa; }
    .signal-meta { color: #a6adc8; }

    .query-controls {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .query-controls > div { display: flex; flex-direction: column; gap: 4px; }
    .query-controls label { font-size: 12px; color: #a6adc8; }

    pre {
      background: #181825;
      border: 1px solid #45475a;
      border-radius: 4px;
      padding: 12px;
      overflow-x: auto;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .hierarchy-tree { font-family: monospace; font-size: 13px; }
    .hierarchy-tree details { margin-left: 20px; }
    .hierarchy-tree summary { cursor: pointer; padding: 2px 0; }
    .hierarchy-tree summary:hover { color: #89b4fa; }
  </style>
</head>
<body>
  <h1>VCD Waveform Parser</h1>
  <h2>WebAssembly Demo - parse VCD files in the browser</h2>

  <div id="status" class="loading">Loading WASM module...</div>

  <!-- File Input -->
  <div class="card">
    <label>Load VCD File</label>
    <input type="file" id="fileInput" accept=".vcd,.VCD" disabled>
    <div style="margin-top: 8px; display: flex; gap: 12px; align-items: center;">
      <label style="margin: 0; font-size: 12px;">Chunk size:</label>
      <input type="number" id="chunkSize" value="10000" min="1">
    </div>
  </div>

  <!-- Metadata -->
  <div class="card" id="metaCard" style="display: none;">
    <h3>Metadata</h3>
    <div class="meta-grid" id="metaGrid"></div>
  </div>

  <!-- Signals -->
  <div class="card" id="signalsCard" style="display: none;">
    <h3>Signals (<span id="signalCountLabel">0</span>)</h3>
    <div class="signal-list" id="signalList"></div>
  </div>

  <!-- Hierarchy -->
  <div class="card" id="hierarchyCard" style="display: none;">
    <h3>Hierarchy</h3>
    <div class="hierarchy-tree" id="hierarchyTree"></div>
  </div>

  <!-- Query -->
  <div class="card" id="queryCard" style="display: none;">
    <h3>Query</h3>
    <div class="query-controls">
      <div>
        <label>t_begin</label>
        <input type="number" id="qBegin" value="0" min="0">
      </div>
      <div>
        <label>t_end</label>
        <input type="number" id="qEnd" value="100" min="0">
      </div>
      <div>
        <label>Signal indices (comma-sep)</label>
        <input type="text" id="qIndices" value="0,1,2" style="width: 200px;">
      </div>
      <div>
        <button id="queryBtn">Run Query</button>
      </div>
    </div>
    <h3>Result</h3>
    <pre id="queryResult">No query run yet.</pre>
  </div>

  <script type="module">
    // Load the WASM module
    import createVcdParser from './vcd_parser.js';

    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('fileInput');
    const chunkSizeInput = document.getElementById('chunkSize');
    const metaCard = document.getElementById('metaCard');
    const metaGrid = document.getElementById('metaGrid');
    const signalsCard = document.getElementById('signalsCard');
    const signalCountLabel = document.getElementById('signalCountLabel');
    const signalList = document.getElementById('signalList');
    const hierarchyCard = document.getElementById('hierarchyCard');
    const hierarchyTree = document.getElementById('hierarchyTree');
    const queryCard = document.getElementById('queryCard');
    const queryBtn = document.getElementById('queryBtn');
    const queryResult = document.getElementById('queryResult');
    const qBegin = document.getElementById('qBegin');
    const qEnd = document.getElementById('qEnd');
    const qIndices = document.getElementById('qIndices');

    let Module = null;
    let parser = null;

    function setStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.className = type;
    }

    // Initialize WASM
    try {
      Module = await createVcdParser();
      setStatus('WASM module loaded. Select a VCD file to parse.', 'ready');
      fileInput.disabled = false;
    } catch (e) {
      setStatus('Failed to load WASM module: ' + e.message, 'error');
      console.error(e);
    }

    // File selection handler
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      setStatus(`Parsing "${file.name}" (${(file.size / 1024).toFixed(1)} KB)...`, 'loading');

      // Cleanup previous parser
      if (parser) {
        parser.close();
        parser.delete();
        parser = null;
      }

      try {
        const arrayBuffer = await file.arrayBuffer();
        const text = new TextDecoder().decode(arrayBuffer);

        const chunkSize = parseInt(chunkSizeInput.value, 10) || 10000;

        parser = new Module.VcdParser();
        const t0 = performance.now();
        const ok = parser.parse(text, chunkSize);
        const elapsed = (performance.now() - t0).toFixed(1);

        if (!ok) {
          setStatus(`Failed to parse "${file.name}".`, 'error');
          return;
        }

        setStatus(`Parsed "${file.name}" in ${elapsed} ms`, 'ready');
        showMetadata();
        showSignals();
        showHierarchy();
        showQueryPanel();
      } catch (err) {
        setStatus('Error: ' + err.message, 'error');
        console.error(err);
      }
    });

    function showMetadata() {
      metaCard.style.display = '';
      const items = [
        { label: 'Date', value: parser.getDate() || '(none)' },
        { label: 'Version', value: parser.getVersion() || '(none)' },
        { label: 'Timescale', value: `${parser.getTimescaleMagnitude()} ${parser.getTimescaleUnit()}` },
        { label: 'Time Range', value: `${parser.getTimeBegin()} - ${parser.getTimeEnd()}` },
        { label: 'Signals', value: parser.getSignalCount() },
        { label: 'Chunks', value: parser.getChunkCount() },
        { label: 'Transitions', value: parser.getTotalTransitions().toLocaleString() },
        { label: 'File Size', value: `${(parser.getFileSize() / 1024).toFixed(1)} KB` },
      ];
      metaGrid.innerHTML = items.map(i =>
        `<div class="meta-item"><div class="label">${i.label}</div><div class="value">${i.value}</div></div>`
      ).join('');
    }

    function showSignals() {
      signalsCard.style.display = '';
      const sigs = JSON.parse(parser.getSignalsJSON());
      signalCountLabel.textContent = sigs.length;
      signalList.innerHTML = sigs.map(s =>
        `<div class="signal-item">
          <span class="signal-path">[${s.index}] ${s.fullPath}</span>
          <span class="signal-meta">${s.type} [${s.width}${s.msb !== undefined ? `:${s.msb}:${s.lsb}` : ''}]</span>
        </div>`
      ).join('');

      // Pre-fill query indices
      qIndices.value = sigs.slice(0, Math.min(5, sigs.length)).map(s => s.index).join(',');
      qBegin.value = parser.getTimeBegin();
      qEnd.value = parser.getTimeEnd();
    }

    function showHierarchy() {
      hierarchyCard.style.display = '';
      const root = JSON.parse(parser.getHierarchyJSON());
      hierarchyTree.innerHTML = renderScope(root);
    }

    function renderScope(node) {
      let html = `<details open><summary>${node.name || '(root)'}`;
      if (node.signals && node.signals.length) {
        html += ` <span style="color:#a6adc8">(${node.signals.length} signals)</span>`;
      }
      html += '</summary>';
      if (node.signals && node.signals.length) {
        html += node.signals.map(i =>
          `<div style="margin-left:20px;color:#a6e3a1;">[${i}]</div>`
        ).join('');
      }
      if (node.children) {
        html += node.children.map(c => renderScope(c)).join('');
      }
      html += '</details>';
      return html;
    }

    function showQueryPanel() {
      queryCard.style.display = '';
    }

    queryBtn.addEventListener('click', () => {
      if (!parser || !parser.isOpen()) {
        queryResult.textContent = 'No file loaded.';
        return;
      }
      const tBegin = parseFloat(qBegin.value) || 0;
      const tEnd = parseFloat(qEnd.value) || 0;
      const indicesStr = qIndices.value.trim();
      const indicesArr = indicesStr.split(',').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n));
      const indicesJSON = JSON.stringify(indicesArr);

      try {
        const t0 = performance.now();
        const resultJSON = parser.query(tBegin, tEnd, indicesJSON);
        const elapsed = (performance.now() - t0).toFixed(3);
        const result = JSON.parse(resultJSON);
        queryResult.textContent = `// Query completed in ${elapsed} ms\n` + JSON.stringify(result, null, 2);
      } catch (err) {
        queryResult.textContent = 'Query error: ' + err.message;
        console.error(err);
      }
    });
  </script>
</body>
</html>
