(function(){"use strict";const T=["0","1","x","z"];class U{parser=null;module;fileExtension="";constructor(e){this.module=e}get isReady(){return!!this.module}get isFileLoaded(){return this.parser!==null&&this.parser.isOpen()}async indexFile(e,t,r){if(this.close(),this.fileExtension=e.split(".").pop()?.toLowerCase()||"",this.fileExtension==="fst"?this.parser=new this.module.FstParser:this.parser=new this.module.VcdParser,!this.parser.open_file(e))return this.close(),!1;this.parser.begin_indexing();let c=0;for(;c<t;){const a=this.parser.index_step(33554432);if(a===0)break;c+=a,r?.(c,t),await new Promise(l=>setTimeout(l,0))}return this.parser.finish_indexing(),this.parser.isOpen()?(r?.(t,t),!0):(this.close(),!1)}async query(e,t,r,c,a=-1,l){this.assertOpen();const o=this.parser,y=this.module,d=Math.floor(e),w=Math.ceil(t),_=o.get_query_plan(BigInt(d));o.begin_query(BigInt(d),BigInt(w),JSON.stringify(r),_.snapshot_index,a);const i=()=>o.cancel_query();c?.addEventListener("abort",i);const s={tBegin:e,tEnd:t,signals:r.map(u=>({index:u,name:"",initialValue:"x",transitions:[]}))};let m=!0;const I=()=>{const u=o.flush_query_binary(),f=this.decodeBinaryResult(u,y,e,t,r);let h=!1;for(let g=0;g<f.signals.length;g++){const p=f.signals[g],S=s.signals[g];m&&(S.name=p.name,S.initialValue=p.initialValue),p.transitions.length>0&&(S.transitions.push(...p.transitions),h=!0)}m=!1,h&&l&&l({...s})};try{for(;;){if(c?.aborted)throw new Error("Query aborted");const u=o.query_step(33554432);if(I(),!u)break;await new Promise(f=>setTimeout(f,0))}}finally{c?.removeEventListener("abort",i)}return I(),s}getMetadata(){this.assertOpen();const e=this.parser;return{date:e.getDate(),version:e.getVersion(),timescaleMagnitude:e.getTimescaleMagnitude(),timescaleUnit:e.getTimescaleUnit(),timeBegin:Number(e.getTimeBegin()),timeEnd:Number(e.getTimeEnd()),signalCount:e.getSignalCount(),snapshotCount:e.getSnapshotCount(),indexMemoryUsage:e.getIndexMemoryUsage()}}getSignals(){return this.assertOpen(),JSON.parse(this.parser.getSignalsJSON())}getHierarchy(){return this.assertOpen(),JSON.parse(this.parser.getHierarchyJSON())}findSignal(e){return this.assertOpen(),this.parser.findSignal(e)}close(){this.parser&&(this.parser.close(),this.parser.delete(),this.parser=null)}decodeBinaryResult(e,t,r,c,a){const l=t.HEAPU8,o=new DataView(l.buffer),y=JSON.parse(this.parser.getSignalsJSON()),d=new Map;for(const i of a){const s=y[i];d.set(i,{index:i,name:s?.fullPath??`signal_${i}`,initialValue:s?.width===1?"x":"bx",transitions:[]})}for(let i=0;i<e.count1Bit;i++){const s=e.ptr1Bit+i*16,m=o.getUint32(s,!0),I=o.getUint32(s+4,!0),u=m+I*4294967296,f=o.getUint32(s+8,!0),h=l[s+12],g=d.get(f);g&&(u<=r?(g.initialValue=T[h]??"x",g.transitions=[]):g.transitions.push([u,T[h]??"x"]))}const w=new TextDecoder;for(let i=0;i<e.countMulti;i++){const s=e.ptrMulti+i*24,m=o.getUint32(s,!0),I=o.getUint32(s+4,!0),u=m+I*4294967296,f=o.getUint32(s+8,!0),h=o.getUint32(s+12,!0),g=o.getUint32(s+16,!0),p=d.get(f);if(!p)continue;const S=l.subarray(e.ptrStringPool+h,e.ptrStringPool+h+g),O=w.decode(S);u<=r?(p.initialValue=O,p.transitions=[]):p.transitions.push([u,O])}const _=[];for(const i of a){const s=d.get(i);s&&_.push(s)}return{tBegin:r,tEnd:c,signals:_}}assertOpen(){if(!this.parser||!this.parser.isOpen())throw new Error("No VCD/FST file is currently loaded")}}let n=null,E=null;self.onmessage=async N=>{const e=N.data;try{switch(e.type){case"INIT":{try{let t=globalThis.createVcdParser;if(!t)try{importScripts(e.wasmJsUri),t=globalThis.createVcdParser}catch(a){console.warn("importScripts failed (likely an ES Module worker). Falling back to fetch+eval:",a);const l=await fetch(e.wasmJsUri);if(!l.ok)throw new Error(`Failed to fetch WASM glue code: ${l.statusText}`);const o=await l.text();t=new Function(`${o}
return createVcdParser;`)()}if(!t)throw new Error("createVcdParser not found after loading script");const r=e.wasmBinaryUri?{locateFile:a=>a.endsWith(".wasm")?e.wasmBinaryUri:a}:void 0,c=await t(r);n=new U(c),self.postMessage({type:"INIT_DONE",success:!0})}catch(t){self.postMessage({type:"INIT_DONE",success:!1,error:t.message})}break}case"INDEX_FILE":{if(!n)throw new Error("Worker not initialized");const t=n.module.FS;try{t.mkdir("/work")}catch{}let r="";if(e.file){r="/work/"+e.file.name;try{t.unmount("/work")}catch{}t.mount(t.filesystems.WORKERFS,{files:[e.file]},"/work")}else e.localPath&&(r=e.localPath);const c=await n.indexFile(r,e.fileSize,(a,l)=>{self.postMessage({type:"INDEX_PROGRESS",bytesRead:a,totalBytes:l})});self.postMessage({type:"INDEX_DONE",success:c});break}case"QUERY":{if(!n)throw new Error("Worker not initialized");E=new AbortController;try{const t=await n.query(e.tBegin,e.tEnd,e.signalIndices,E.signal,e.pixelTimeStep,r=>{self.postMessage({type:"QUERY_PROGRESS",result:r})});self.postMessage({type:"QUERY_DONE",result:t})}catch(t){t.name==="AbortError"||self.postMessage({type:"QUERY_DONE",result:{tBegin:e.tBegin,tEnd:e.tEnd,signals:[]},error:t.message})}finally{E=null}break}case"ABORT_QUERY":{E&&(E.abort(),E=null);break}case"GET_METADATA":{if(!n)return;self.postMessage({type:"METADATA_RESULT",requestId:e.requestId,data:n.getMetadata()});break}case"GET_SIGNALS":{if(!n)return;self.postMessage({type:"SIGNALS_RESULT",requestId:e.requestId,data:n.getSignals()});break}case"GET_HIERARCHY":{if(!n)return;self.postMessage({type:"HIERARCHY_RESULT",requestId:e.requestId,data:n.getHierarchy()});break}case"FIND_SIGNAL":{if(!n)return;self.postMessage({type:"FIND_SIGNAL_RESULT",requestId:e.requestId,data:n.findSignal(e.fullPath)});break}case"CLOSE":{n&&n.close();break}}}catch(t){console.error("Worker error:",t)}}})();
