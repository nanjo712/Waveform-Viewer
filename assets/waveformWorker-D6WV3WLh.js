(function(){"use strict";const R=["0","1","x","z"];class b{parser=null;module;fileExtension="";constructor(e){this.module=e}get isReady(){return!!this.module}get isFileLoaded(){return this.parser!==null&&this.parser.isOpen()}async indexFile(e,t,r){if(this.close(),this.fileExtension=e.split(".").pop()?.toLowerCase()||"",this.fileExtension==="fst"?this.parser=new this.module.FstParser:this.parser=new this.module.VcdParser,!this.parser.open_file(e))return this.close(),!1;this.parser.begin_indexing();let c=0;for(;c<t;){const a=this.parser.index_step(33554432);if(a===0)break;c+=a,r?.(c,t),await new Promise(l=>setTimeout(l,0))}return this.parser.finish_indexing(),this.parser.isOpen()?(r?.(t,t),!0):(this.close(),!1)}async query(e,t,r,c,a=-1,l){this.assertOpen();const o=this.parser,y=this.module,h=Math.floor(e),N=Math.ceil(t),_=o.get_query_plan(BigInt(h));o.begin_query(BigInt(h),BigInt(N),JSON.stringify(r),_.snapshot_index,a);const n=()=>o.cancel_query();c?.addEventListener("abort",n);const s={tBegin:e,tEnd:t,signals:r.map(u=>({index:u,name:"",initialValue:"x",transitions:[]}))},I=100;let S=0,p=!0;const m=(u=!1)=>{const g=o.flush_query_binary(),d=this.decodeBinaryResult(g,y,e,t,r);let w=!1;for(let f=0;f<d.signals.length;f++){const T=d.signals[f],O=s.signals[f];p&&(O.name=T.name,O.initialValue=T.initialValue),T.transitions.length>0&&(O.transitions.push(...T.transitions),w=!0)}if(p=!1,w&&l){const f=Date.now();(u||f-S>I)&&(l({...s}),S=f)}};try{for(;;){if(c?.aborted)throw new Error("Query aborted");const u=o.query_step(33554432);if(m(),!u)break;await new Promise(g=>setTimeout(g,0))}}finally{c?.removeEventListener("abort",n)}return m(!0),s}getMetadata(){this.assertOpen();const e=this.parser;return{date:e.getDate(),version:e.getVersion(),timescaleMagnitude:e.getTimescaleMagnitude(),timescaleUnit:e.getTimescaleUnit(),timeBegin:Number(e.getTimeBegin()),timeEnd:Number(e.getTimeEnd()),signalCount:e.getSignalCount(),snapshotCount:e.getSnapshotCount(),indexMemoryUsage:e.getIndexMemoryUsage()}}getSignals(){return this.assertOpen(),JSON.parse(this.parser.getSignalsJSON())}getHierarchy(){return this.assertOpen(),JSON.parse(this.parser.getHierarchyJSON())}findSignal(e){return this.assertOpen(),this.parser.findSignal(e)}close(){this.parser&&(this.parser.close(),this.parser.delete(),this.parser=null)}decodeBinaryResult(e,t,r,c,a){const l=t.HEAPU8,o=new DataView(l.buffer),y=JSON.parse(this.parser.getSignalsJSON()),h=new Map;for(const n of a){const s=y[n];h.set(n,{index:n,name:s?.fullPath??`signal_${n}`,initialValue:s?.width===1?"x":"bx",transitions:[]})}for(let n=0;n<e.count1Bit;n++){const s=e.ptr1Bit+n*16,I=o.getUint32(s,!0),S=o.getUint32(s+4,!0),p=I+S*4294967296,m=o.getUint32(s+8,!0),u=l[s+12],g=h.get(m);g&&(p<=r?(g.initialValue=R[u]??"x",g.transitions=[]):g.transitions.push([p,R[u]??"x"]))}const N=new TextDecoder;for(let n=0;n<e.countMulti;n++){const s=e.ptrMulti+n*24,I=o.getUint32(s,!0),S=o.getUint32(s+4,!0),p=I+S*4294967296,m=o.getUint32(s+8,!0),u=o.getUint32(s+12,!0),g=o.getUint32(s+16,!0),d=h.get(m);if(!d)continue;const w=l.subarray(e.ptrStringPool+u,e.ptrStringPool+u+g),f=N.decode(w);p<=r?(d.initialValue=f,d.transitions=[]):d.transitions.push([p,f])}const _=[];for(const n of a){const s=h.get(n);s&&_.push(s)}return{tBegin:r,tEnd:c,signals:_}}assertOpen(){if(!this.parser||!this.parser.isOpen())throw new Error("No VCD/FST file is currently loaded")}}let i=null,E=null;self.onmessage=async U=>{const e=U.data;try{switch(e.type){case"INIT":{try{let t=globalThis.createVcdParser;if(!t)try{importScripts(e.wasmJsUri),t=globalThis.createVcdParser}catch(a){console.warn("importScripts failed (likely an ES Module worker). Falling back to fetch+eval:",a);const l=await fetch(e.wasmJsUri);if(!l.ok)throw new Error(`Failed to fetch WASM glue code: ${l.statusText}`);const o=await l.text();t=new Function(`${o}
return createVcdParser;`)()}if(!t)throw new Error("createVcdParser not found after loading script");const r=e.wasmBinaryUri?{locateFile:a=>a.endsWith(".wasm")?e.wasmBinaryUri:a}:void 0,c=await t(r);i=new b(c),self.postMessage({type:"INIT_DONE",success:!0})}catch(t){self.postMessage({type:"INIT_DONE",success:!1,error:t.message})}break}case"INDEX_FILE":{if(!i)throw new Error("Worker not initialized");const t=i.module.FS;try{t.mkdir("/work")}catch{}let r="";if(e.file){r="/work/"+e.file.name;try{t.unmount("/work")}catch{}t.mount(t.filesystems.WORKERFS,{files:[e.file]},"/work")}else e.localPath&&(r=e.localPath);const c=await i.indexFile(r,e.fileSize,(a,l)=>{self.postMessage({type:"INDEX_PROGRESS",bytesRead:a,totalBytes:l})});self.postMessage({type:"INDEX_DONE",success:c});break}case"QUERY":{if(!i)throw new Error("Worker not initialized");E=new AbortController;try{const t=await i.query(e.tBegin,e.tEnd,e.signalIndices,E.signal,e.pixelTimeStep,r=>{self.postMessage({type:"QUERY_PROGRESS",result:r})});self.postMessage({type:"QUERY_DONE",result:t})}catch(t){t.name==="AbortError"||self.postMessage({type:"QUERY_DONE",result:{tBegin:e.tBegin,tEnd:e.tEnd,signals:[]},error:t.message})}finally{E=null}break}case"ABORT_QUERY":{E&&(E.abort(),E=null);break}case"GET_METADATA":{if(!i)return;self.postMessage({type:"METADATA_RESULT",requestId:e.requestId,data:i.getMetadata()});break}case"GET_SIGNALS":{if(!i)return;self.postMessage({type:"SIGNALS_RESULT",requestId:e.requestId,data:i.getSignals()});break}case"GET_HIERARCHY":{if(!i)return;self.postMessage({type:"HIERARCHY_RESULT",requestId:e.requestId,data:i.getHierarchy()});break}case"FIND_SIGNAL":{if(!i)return;self.postMessage({type:"FIND_SIGNAL_RESULT",requestId:e.requestId,data:i.findSignal(e.fullPath)});break}case"CLOSE":{i&&i.close();break}}}catch(t){console.error("Worker error:",t)}}})();
